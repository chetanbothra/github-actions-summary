name: "Kubernetes Deployment Summary"
description: "Generate GitHub Summary for K8s resource (Deployment, StatefulSet, or DaemonSet)"
author: "DevOps Bot"

inputs:
  namespace:
    required: true
  app_name:
    required: true
  notify_users:
    required: false
    default: ""

outputs:
  result:
    description: "success or failure"

runs:
  using: "composite"
  steps:

    - name: Kubernetes Deployment Summary
      shell: bash
      run: |
        set -euo pipefail

        NS="${{ inputs.namespace }}"
        APP="${{ inputs.app_name }}"
        USERS="${{ inputs.notify_users }}"

        echo "ðŸ”Ž Detecting resource type..."

        if kubectl get deploy "$APP" -n "$NS" --ignore-not-found --no-headers | grep -q .; then
          RESOURCE_TYPE="deployment"
        elif kubectl get statefulset "$APP" -n "$NS" --ignore-not-found --no-headers | grep -q .; then
          RESOURCE_TYPE="statefulset"
        elif kubectl get daemonset "$APP" -n "$NS" --ignore-not-found --no-headers | grep -q .; then
          RESOURCE_TYPE="daemonset"
        else
          echo "âŒ Resource '$APP' not found in '$NS'"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "â³ Checking rollout status..."

        ROLLOUT_OK=true
        if ! kubectl rollout status $RESOURCE_TYPE/"$APP" -n "$NS" --timeout=120s; then
          ROLLOUT_OK=false
        fi

        echo "## ðŸš€ Kubernetes Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Namespace:** $NS" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource:** $RESOURCE_TYPE/$APP" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by:** @${GITHUB_ACTOR}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### ðŸ” Pods" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

        PODS_JSON=$(kubectl get pods -n "$NS" -l app="$APP" -o json)

        echo "$PODS_JSON" | jq -r '
          .items[] |
          . as $pod |
          (
            ($pod.status.containerStatuses // []) |
            map(.ready) |
            map(select(. == true)) |
            length
          ) as $ready
          |
          (
            ($pod.status.containerStatuses // []) |
            length
          ) as $total
          |
          (
            if ($pod.status.containerStatuses[0].state.waiting.reason) then
              $pod.status.containerStatuses[0].state.waiting.reason
            elif ($pod.status.containerStatuses[0].state.terminated.reason) then
              $pod.status.containerStatuses[0].state.terminated.reason
            else
              $pod.status.phase
            end
          ) as $status
          |
          (
            ($pod.status.containerStatuses // []) |
            map(.restartCount // 0) |
            add
          ) as $restarts
          |
          (
            (now - (.metadata.creationTimestamp | fromdate)) / 60 | floor | tostring + "m"
          ) as $age
          |
          "\($pod.metadata.name)   \($ready)/\($total)   \($status)   \($restarts)   \($age)   \($pod.spec.nodeName)"
        ' >> $GITHUB_STEP_SUMMARY

        echo '```' >> $GITHUB_STEP_SUMMARY

        echo ""
        echo "### ðŸ”Ž Checking for problematic pods..." >> $GITHUB_STEP_SUMMARY

        BAD_PODS=$(echo "$PODS_JSON" | jq -r '
          .items[]
          | select(
              (.status.containerStatuses[]?.state.waiting.reason == "CrashLoopBackOff")
              or (.status.containerStatuses[]?.state.waiting.reason == "Error")
              or (.status.containerStatuses[]?.state.waiting.reason == "CreateContainerConfigError")
              or (.status.containerStatuses[]?.state.waiting.reason == "ImagePullBackOff")
              or ((.status.containerStatuses[]?.restartCount // 0) > 3)
          )
          | .metadata.name
        ')

        FAILURE=false

        if [ -n "$BAD_PODS" ]; then
          FAILURE=true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Problematic Pods Detected" >> $GITHUB_STEP_SUMMARY

          if [ -n "$USERS" ]; then
            M="@${USERS//,/ @}"
            echo "- Notifying: $M" >> $GITHUB_STEP_SUMMARY
          fi

          for P in $BAD_PODS; do
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### âŒ $P" >> $GITHUB_STEP_SUMMARY

            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl describe pod "$P" -n "$NS" || true
            echo '```' >> $GITHUB_STEP_SUMMARY

            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs "$P" -n "$NS" --all-containers --tail=200 || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          done
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ•‘ Recent Namespace Events" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        kubectl get events -n "$NS" --sort-by='.metadata.creationTimestamp' | tail -50 || true
        echo '```' >> $GITHUB_STEP_SUMMARY

        # FINAL RESULT
        if [ "$ROLLOUT_OK" = false ] || [ "$FAILURE" = true ]; then
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "result=success" >> $GITHUB_OUTPUT
